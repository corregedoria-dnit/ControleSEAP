<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Processos Correicionais</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/inputmask.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .shadow, .shadow-lg, .border { box-shadow: none !important; border: none !important; }
            .page-break { page-break-before: always; }
            .bg-gray-50, .bg-white { background-color: white !important; }
        }
        
        .print-only { display: none; }
        :root { --primary-color: #1e40af; }
        
        .scrollbar-thin { scrollbar-width: thin; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        
        .mask-sei { font-family: 'Monaco', 'Menlo', monospace; }
        .required-field::after { content: "*"; color: #dc2626; margin-left: 2px; }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos do Relatório */
        .report-section { border: 1px solid #e5e7eb; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 0.5rem; page-break-inside: avoid; background-color: white; }
        .report-header { font-size: 1.25rem; font-weight: bold; color: #1f2937; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        .report-sub-header { font-size: 1rem; font-weight: bold; color: #374151; margin-top: 1rem; margin-bottom: 0.5rem; background-color: #f3f4f6; padding: 0.5rem; border-radius: 0.25rem; }
        .report-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dotted #e5e7eb; font-size: 0.9rem; }
        .report-item:last-child { border-bottom: none; }
        .analytic-list { margin-top: 0.25rem; margin-bottom: 0.75rem; padding-left: 1rem; border-left: 3px solid #bfdbfe; font-size: 0.8rem; color: #4b5563; }
        
        /* Lista Split View */
        .split-view { display: flex; height: calc(100vh - 220px); border: 1px solid #e5e7eb; background: white; border-radius: 0.5rem; overflow: hidden; width: 100%; }
        .split-list { width: 30%; min-width: 300px; border-right: 1px solid #e5e7eb; overflow-y: auto; background-color: #f9fafb; }
        .split-detail { flex: 1; overflow-y: auto; padding: 2rem; background-color: white; }
        .list-item { padding: 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s; }
        .list-item:hover { background-color: #e5e7eb; }
        .list-item.active { background-color: #eff6ff; border-left: 4px solid #1e40af; }
        
        /* Status Badges */
        .status-badge { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; white-space: nowrap; }
        .st-aguardando { background-color: #e0e7ff; color: #3730a3; }
        .st-analise { background-color: #fef3c7; color: #92400e; }
        .st-pendente { background-color: #ffedd5; color: #9a3412; }
        .st-concluido { background-color: #d1fae5; color: #065f46; }
        
        /* Tabela */
        .table-container { width: 100%; overflow-x: auto; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { white-space: nowrap; padding: 0.75rem 1rem; text-align: left; }
        .priority-highlight { font-weight: bold; background-color: #fef9c3 !important; }
        .resizable-v { resize: vertical; overflow: auto; min-height: 200px; }

        /* Login e App Overlay */
        #login-overlay { position: fixed; inset: 0; background: #f3f4f6; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        #app { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="login-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-200 animate-fadeIn">
            
            <div id="login-section">
                <div class="flex justify-center mb-6">
                    <div class="bg-blue-600 p-3 rounded-full"><i data-lucide="shield-check" class="text-white w-8 h-8"></i></div>
                </div>
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Acesso ao Sistema</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Usuário</label>
                        <input type="text" id="log-user" required class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Senha</label>
                        <input type="password" id="log-pass" required class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <button type="button" onclick="handleLogin(event)" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold transition-colors">Entrar</button>
                </form>
            </div>
            
            <p id="error-msg" class="text-red-500 text-sm mt-4 hidden text-center font-bold"></p>
        </div>
    </div>

    <div id="app" class="min-h-screen flex flex-col">
        <header class="bg-white shadow-sm border-b sticky top-0 z-50 no-print">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-blue-600 p-2 rounded-lg">
                            <i data-lucide="scale" class="text-white w-6 h-6"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900" id="header-org-name">Controle Correicional</h1>
                            <div class="flex items-center space-x-2">
                                <p class="text-sm text-gray-600" id="header-subtitle">Sistema Institucional</p>
                                <span id="admin-badge" class="hidden bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-0.5 rounded uppercase border border-purple-200">Admin</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="db-status" class="flex items-center space-x-2 px-3 py-1 bg-yellow-50 text-yellow-700 rounded-full border border-yellow-200" title="Sincronizando...">
                            <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                            <span class="text-xs font-medium">Conectando...</span>
                        </div>
                        <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition-colors" title="Sair do Sistema">
                             <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Sair
                        </button>
                    </div>
                </div>
                
                <nav class="flex space-x-1 border-t pt-2 pb-2 overflow-x-auto">
                    <button onclick="showPage('dashboard')" id="nav-dashboard" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-100 flex items-center bg-blue-50 text-blue-700">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 mr-2"></i> Dashboard
                    </button>
                    <button onclick="showPage('processos')" id="nav-processos" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-100 flex items-center">
                        <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> Processos
                    </button>
                    <button onclick="showPage('novo-processo')" id="nav-novo-processo" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-100 flex items-center">
                        <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> Novo Processo
                    </button>
                    <button onclick="showPage('relatorios')" id="nav-relatorios" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-100 flex items-center">
                        <i data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i> Relatórios
                    </button>
                    <button onclick="showPage('configuracoes')" id="nav-configuracoes" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-100 flex items-center">
                        <i data-lucide="settings" class="w-4 h-4 mr-2"></i> Configurações
                    </button>
                </nav>
            </div>
        </header>

        <main class="flex-grow w-full px-4 sm:px-6 lg:px-8 py-6">
            <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50 no-print"></div>
            
            <div id="page-dashboard" class="page-content animate-fadeIn max-w-7xl mx-auto">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Visão Geral</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                        <p class="text-sm text-gray-500">Total de Processos</p>
                        <p id="stat-total" class="text-2xl font-bold">...</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-indigo-500">
                        <p class="text-sm text-gray-500">Aguardando Distribuição</p>
                        <p id="stat-aguardando" class="text-2xl font-bold">...</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500">
                        <p class="text-sm text-gray-500">Em Análise</p>
                        <p id="stat-analise" class="text-2xl font-bold">...</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                        <p class="text-sm text-gray-500">Concluídos</p>
                        <p id="stat-concluidos" class="text-2xl font-bold">...</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center text-gray-800"><i data-lucide="file-clock" class="w-5 h-5 mr-2"></i> Controle de Prazo da Nota Técnica</h3>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                           <p class="text-sm text-green-700">Dentro do Prazo</p>
                           <p id="prazont-ok" class="text-2xl font-bold text-green-800">...</p>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                           <p class="text-sm text-yellow-700">Próximos do Vencimento</p>
                           <p id="prazont-alerta" class="text-2xl font-bold text-yellow-800">...</p>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                           <p class="text-sm text-red-700">Vencidos</p>
                           <p id="prazont-vencido" class="text-2xl font-bold text-red-800">...</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-4 flex items-center text-red-700"><i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i> Atenção: Prazos e Tarefas Críticas</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold text-gray-600 text-sm border-b pb-1 mb-2">Prazos de Nota Técnica</h4>
                                <div id="task-list-dashboard" class="overflow-y-auto max-h-48 text-sm scrollbar-thin">Carregando...</div>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-600 text-sm border-b pb-1 mb-2">Risco de Prescrição</h4>
                                <div id="presc-list-dashboard" class="overflow-y-auto max-h-48 text-sm scrollbar-thin">Carregando...</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-4">Status dos Processos</h3>
                        <div id="chart-status" class="space-y-3">Carregando...</div>
                    </div>
                </div>
            </div>

            <div id="page-processos" class="page-content hidden animate-fadeIn w-full max-w-7xl mx-auto">
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                        <div class="flex flex-wrap items-center w-full md:w-auto gap-2">
                            <input type="text" id="search-process" placeholder="Buscar em todos os campos..." class="border rounded px-3 py-2 text-sm w-full md:w-64" oninput="refreshProcessos()">
                            
                            <button onclick="toggleAdvancedFilters()" class="bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm hover:bg-gray-300 flex items-center">
                                <i data-lucide="filter" class="w-4 h-4 mr-1"></i> Filtros
                            </button>
                            
                            <button id="btn-filter-priority" onclick="togglePriorityFilter()" class="border border-yellow-400 text-yellow-700 bg-yellow-50 px-3 py-2 rounded text-sm hover:bg-yellow-100 flex items-center transition-colors">
                                <i data-lucide="star" class="w-4 h-4 mr-1"></i> Prioritários
                            </button>
                            
                            <button onclick="clearAllFilters()" class="text-gray-500 hover:text-red-500 text-sm px-2 flex items-center" title="Limpar Filtros"><i data-lucide="x-circle" class="w-4 h-4 mr-1"></i> Limpar</button>
                            
                            <button onclick="refreshProcessos()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Atualizar</button>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-600">Ordenar por</label>
                                <select id="process-sort" onchange="refreshProcessos()" class="border rounded px-2 py-1 text-sm mt-1">
                                    <option value="data_ent_desc">Data de entrada (mais recente)</option>
                                    <option value="data_ent_asc">Data de entrada (mais antiga)</option>
                                    <option value="sei_asc">SEI (A-Z)</option>
                                    <option value="status_asc">Status (A-Z)</option>
                                    <option value="analista_asc">Analista (A-Z)</option>
                                </select>
                            </div>
                        <div class="flex bg-gray-100 p-1 rounded-lg">
                            <button onclick="setViewMode('cards')" class="view-btn p-2 rounded text-sm flex items-center space-x-1 hover:bg-white hover:shadow" id="btn-view-cards"><i data-lucide="grid" class="w-4 h-4"></i> <span>Cards</span></button>
                            <button onclick="setViewMode('table')" class="view-btn p-2 rounded text-sm flex items-center space-x-1 hover:bg-white hover:shadow" id="btn-view-table"><i data-lucide="table" class="w-4 h-4"></i> <span>Tabela</span></button>
                            <button onclick="setViewMode('list')" class="view-btn p-2 rounded text-sm flex items-center space-x-1 hover:bg-white hover:shadow" id="btn-view-list"><i data-lucide="layout-list" class="w-4 h-4"></i> <span>Lista</span></button>
                        </div>
                        </div>
                    </div>
                    
                    <div id="advanced-filters-panel" class="hidden border-t mt-4 pt-4">
                        <h4 class="text-sm font-bold text-gray-700 mb-3">Filtros Detalhados</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto pr-2 scrollbar-thin pb-2">
                            <div><label class="block text-xs font-bold text-gray-600">Status</label><select id="fp-status" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"><option value="">Todos</option><option value="Cadastrado">Cadastrado</option><option value="Aguardando Distribuição">Aguardando Distribuição</option><option value="Em análise">Em análise</option><option value="Pendente de análise do(a) Corregedor(a)">Pendente de análise do(a) Corregedor(a)</option><option value="Concluído">Concluído</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-600">Processo SEI</label><input type="text" id="fp-sei" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Objeto</label><input type="text" id="fp-objeto" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Acusado(s)</label><input type="text" id="fp-acusados" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Analista Responsável</label><input type="text" id="fp-analista" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Resultado</label><select id="fp-resultado" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"><option value="">Todos</option><option value="Não definida">Não definida</option><option value="Instauração de PAD">Instauração de PAD</option><option value="Instauração de PAR">Instauração de PAR</option><option value="Instauração de SINPA">Instauração de SINPA</option><option value="Instauração de SINAC">Instauração de SINAC</option><option value="Instauração de SINVE">Instauração de SINVE</option><option value="Instauração de IPS">Instauração de IPS</option><option value="Encaminhado para o Min. dos Transportes">Min. Transportes</option><option value="Para celebrar TAC">Para celebrar TAC</option><option value="Arquivado após análise preliminar">Arquivado após análise preliminar</option><option value="Arquivado após juízo de admissibilidade">Arquivado após juízo de admissibilidade</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-600">Tipo de Pessoa</label><select id="fp-tipo_acusado" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"><option value="">Todos</option><option value="Pessoa Física">Pessoa Física</option><option value="Pessoa Jurídica">Pessoa Jurídica</option><option value="Pessoa Física + Jurídica">Pessoa Física + Jurídica</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-600">Penalidades Aplicáveis</label><select id="fp-penalidades" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"><option value="">Todas</option><option value="Não se aplica">Não se aplica</option><option value="Advertência">Advertência</option><option value="Suspensão">Suspensão</option><option value="Demissão">Demissão</option><option value="Multa (PJ)">Multa (PJ)</option><option value="Outras">Outras</option></select></div>
                            
                            <div><label class="block text-xs font-bold text-gray-600">Data de Entrada</label><input type="date" id="fp-data_ent" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Data Conhecimento Fato</label><input type="date" id="fp-data_conhecimento" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Data de Distribuição</label><input type="date" id="fp-data_distribuicao" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Prazo para NT</label><input type="date" id="fp-prazo_nt_data" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Data de Entrega NT</label><input type="date" id="fp-data_entrega_nt" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Data Despacho</label><input type="date" id="fp-data_despacho" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            
                            <div><label class="block text-xs font-bold text-gray-600">Unidade de Origem</label><input type="text" id="fp-unidade_origem" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Documento de Origem</label><input type="text" id="fp-doc_origem" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Juntado a Processo</label><input type="text" id="fp-juntado" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Processos Relacionados</label><input type="text" id="fp-relacionados" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Documento de Resposta</label><input type="text" id="fp-doc_resp" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            
                            <div><label class="block text-xs font-bold text-gray-600">Operação Policial?</label><select id="fp-op_policial" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"><option value="">Todos</option><option value="true">Sim</option><option value="false">Não</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-600">Detalhes Op. Policial</label><input type="text" id="fp-op_policial_detalhes" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Possui Inquérito?</label><select id="fp-possui_inquerito" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"><option value="">Todos</option><option value="true">Sim</option><option value="false">Não</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-600">Nº do Inquérito</label><input type="text" id="fp-inquerito_detalhes" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-600">Cadastro ePAD?</label><select id="fp-cad_epad" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"><option value="">Todos</option><option value="true">Sim</option><option value="false">Não</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-600">Processo ePAD</label><input type="text" id="fp-epad_detalhes" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            
                            <div><label class="block text-xs font-bold text-gray-600">Apto a TAC?</label><select id="fp-tac_apto" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"><option value="">Todos</option><option value="true">Sim</option><option value="false">Não</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-600">Situação do TAC</label><select id="fp-tac_sit" onchange="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"><option value="">Todas</option><option value="Em negociação">Em negociação</option><option value="Celebrado">Celebrado</option><option value="Recusado">Recusado</option><option value="Finalizado">Finalizado</option></select></div>
                            <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-600">Observações do TAC</label><input type="text" id="fp-tac_obs" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                            
                            <div class="md:col-span-3 lg:col-span-4"><label class="block text-xs font-bold text-gray-600">Observações Gerais</label><input type="text" id="fp-obs" oninput="refreshProcessos()" class="w-full border rounded px-2 py-1 mt-1 text-sm"></div>
                        </div>
                    </div>
                </div>

                <div id="process-view-container" class="w-full"></div>
            </div>

            <div id="page-novo-processo" class="page-content hidden animate-fadeIn max-w-7xl mx-auto">
                <div class="mb-6"><h2 id="novo-processo-title" class="text-2xl font-bold">Novo Processo</h2></div>
                <form id="process-form" class="bg-white p-6 rounded-lg shadow space-y-8">
                    <input type="hidden" id="process-id">
                    
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center"><i data-lucide="file-search" class="w-5 h-5 mr-2 text-blue-600"></i>BLOCO 1 – IDENTIFICAÇÃO</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div><label class="block text-sm font-medium required-field">Processo SEI</label><input type="text" id="process-sei" class="w-full border rounded px-3 py-2 mt-1 mask-sei" placeholder="00000.000000/0000-00"></div>
                            <div><label class="block text-sm font-medium">Data de Entrada</label><input type="date" id="process-data-entrada" class="w-full border rounded px-3 py-2 mt-1"></div>
                            <div><label class="block text-sm font-medium required-field">Data Conhecimento do Fato</label><input type="date" id="process-data-conhecimento" class="w-full border rounded px-3 py-2 mt-1" onchange="calculatePrescription()"></div>
                            
                            <div class="md:col-span-3"><label class="block text-sm font-medium required-field">Objeto</label><input type="text" id="process-objeto" class="w-full border rounded px-3 py-2 mt-1"></div>
                            
                            <div><label class="block text-sm font-medium">Unidade de Origem</label><input type="text" id="process-unidade-origem" class="w-full border rounded px-3 py-2 mt-1"></div>
                            <div><label class="block text-sm font-medium">Documento de Origem</label><input type="text" id="process-doc-origem" class="w-full border rounded px-3 py-2 mt-1"></div>
                            <div><label class="block text-sm font-medium">Juntado a Processo</label><input type="text" id="process-juntado" class="w-full border rounded px-3 py-2 mt-1 mask-sei" placeholder="00000.000000/0000-00"></div>
                            
                            <div class="md:col-span-3"><label class="block text-sm font-medium">Processos Relacionados</label><input type="text" id="process-relacionados" class="w-full border rounded px-3 py-2 mt-1"></div>
                        </div>

                        <div class="mt-6">
                            <label class="block text-sm font-medium required-field">Acusado(s)</label>
                            <div class="flex space-x-2 mt-1">
                                <input type="text" id="input-acusado" class="flex-1 border rounded px-3 py-2" placeholder="Nome do acusado">
                                <button type="button" onclick="addAcusado()" class="bg-gray-200 px-4 rounded hover:bg-gray-300">Adicionar</button>
                            </div>
                            <div id="lista-acusados" class="mt-2 flex flex-wrap gap-2"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                <label class="block text-sm font-medium required-field mb-1">Tipo de Pessoa</label>
                                <select id="process-tipo-acusado" class="w-full border rounded px-3 py-2 bg-gray-50" onchange="calculatePrescription()">
                                    <option value="">Selecione...</option>
                                    <option value="Pessoa Física">Pessoa Física</option>
                                    <option value="Pessoa Jurídica">Pessoa Jurídica</option>
                                    <option value="Pessoa Física + Jurídica">Pessoa Física + Jurídica</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium">Penalidades Aplicáveis</label>
                                <select id="process-penalidades" class="w-full border rounded px-3 py-2 bg-gray-50">
                                    <option value="">Não se aplica</option>
                                    <option value="Advertência">Advertência</option>
                                    <option value="Suspensão">Suspensão</option>
                                    <option value="Demissão">Demissão</option>
                                    <option value="Multa (PJ)">Multa (PJ)</option>
                                    <option value="Outras">Outras</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-4 border-t grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-center">
                            <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="check-policial" onchange="toggleConditionalField('policial-details', this.checked)"><span>É operação policial?</span></label>
                            <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="check-inquerito" onchange="toggleConditionalField('inquerito-details', this.checked)"><span>Possui inquérito?</span></label>
                            <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="check-epad" onchange="toggleConditionalField('epad-details', this.checked)"><span>Cadastro no ePAD?</span></label>
                            <label class="flex items-center space-x-2 text-sm font-bold text-yellow-700"><input type="checkbox" id="process-prioritario"><span>Processo prioritário?</span></label>
                        </div>
                        <div class="mt-4 space-y-3">
                            <div id="policial-details" class="hidden"><label class="block text-sm font-medium text-gray-600">Detalhes da Operação Policial</label><input type="text" id="process-op-policial-detalhes" class="w-full border rounded px-3 py-2 mt-1"></div>
                            <div id="inquerito-details" class="hidden"><label class="block text-sm font-medium text-gray-600">Nº do Inquérito</label><input type="text" id="process-inquerito-detalhes" class="w-full border rounded px-3 py-2 mt-1"></div>
                            <div id="epad-details" class="hidden"><label class="block text-sm font-medium text-gray-600">Nº do Processo ePAD</label><input type="text" id="process-epad-detalhes" class="w-full border rounded px-3 py-2 mt-1"></div>
                        </div>
                        
                        <div class="mt-4 bg-yellow-50 p-4 rounded text-sm">
                             <h4 class="text-sm font-semibold mb-2 text-gray-600">Prazos Prescricionais Calculados</h4>
                            <div id="container-pf" class="grid grid-cols-3 gap-4 hidden">
                                <div><label>Advertência</label><input id="calc-advertencia" class="w-full bg-transparent font-bold" readonly></div>
                                <div><label>Suspensão</label><input id="calc-suspensao" class="w-full bg-transparent font-bold" readonly></div>
                                <div><label>Demissão</label><input id="calc-demissao" class="w-full bg-transparent font-bold" readonly></div>
                            </div>
                            <div id="container-pj" class="mt-2 hidden">
                                <div><label class="font-bold text-blue-800">Prescrição PJ</label><input id="calc-pj" class="w-full bg-transparent font-bold text-blue-800" readonly></div>
                            </div>
                        </div>
                    </div>

                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center"><i data-lucide="users" class="w-5 h-5 mr-2 text-blue-600"></i>BLOCO 2 – DISTRIBUIÇÃO E ANÁLISE</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                             <div><label class="block text-sm font-medium">Analista Responsável</label><input type="text" id="process-analista" class="w-full border rounded px-3 py-2 mt-1" list="analistas-list"></div>
                             <div><label class="block text-sm font-medium">Data de Distribuição</label><input type="date" id="process-data-distribuicao" class="w-full border rounded px-3 py-2 mt-1"></div>
                             <div>
                                <label class="block text-sm font-medium">Prazo para Conclusão da NT</label>
                                <div class="flex items-center mt-1">
                                    <input type="number" id="process-prazo-dias" class="w-20 border rounded-l px-3 py-2" placeholder="Dias">
                                    <input type="date" id="process-prazo-data" class="flex-1 border-t border-b border-r rounded-r px-3 py-2">
                                </div>
                             </div>
                             <div>
                                <label class="block text-sm font-medium">Data de Entrega da NT</label>
                                <input type="date" id="process-data-entrega-nt" class="w-full border rounded px-3 py-2 mt-1">
                             </div>
                             <div>
                                <label class="block text-sm font-medium">IPS?</label>
                                <select id="process-ips" class="w-full border rounded px-3 py-2 mt-1">
                                    <option value="">Não informado</option>
                                    <option value="true">Sim</option>
                                    <option value="false">Não</option>
                                </select>
                             </div>
                        </div>
                        <datalist id="analistas-list"></datalist>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center"><i data-lucide="check-circle" class="w-5 h-5 mr-2 text-blue-600"></i>BLOCO 3 – RESULTADO E OBSERVAÇÕES</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                            <div>
                                <label class="block text-sm font-medium">Status do Processo</label>
                                <select id="process-status-manual" class="w-full border rounded px-3 py-2 mt-1 bg-yellow-50">
                                    <option value="">Automático</option>
                                    <option value="Cadastrado">Cadastrado</option><option value="Aguardando Distribuição">Aguardando Distribuição</option>
                                    <option value="Em análise">Em análise</option>
                                    <option value="Pendente de análise do(a) Corregedor(a)">Pendente de análise do(a) Corregedor(a)</option>
                                    <option value="Concluído">Concluído</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Data de Assinatura Despacho Decisório</label>
                                <input type="date" id="process-data-despacho" class="w-full border rounded px-3 py-2 mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Resultado</label>
                                <select id="process-resultado" class="w-full border rounded px-3 py-2 mt-1">
                                    <option value="Não definida">Não definida</option>
                                    <option value="Instauração de PAD">Instauração de PAD</option>
                                    <option value="Instauração de PAR">Instauração de PAR</option>
                                    <option value="Instauração de SINPA">Instauração de SINPA</option>
                                    <option value="Instauração de SINAC">Instauração de SINAC</option>
                                    <option value="Instauração de SINVE">Instauração de SINVE</option>
                                    <option value="Instauração de IPS">Instauração de IPS</option>
                                    <option value="Encaminhado para o Min. dos Transportes">Min. Transportes</option>
                                    <option value="Para celebrar TAC">Para celebrar TAC</option>
                                    <option value="Arquivado após análise preliminar">Arquivado após análise preliminar</option><option value="Arquivado após juízo de admissibilidade">Arquivado após juízo de admissibilidade</option>
                                </select>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium">Documento de Resposta</label><input type="text" id="process-doc-resposta" class="w-full border rounded px-3 py-2 mt-1">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                             <label class="flex items-center space-x-2 font-medium"><input type="checkbox" id="check-tac" onclick="toggleTacDetails()"> <span>Apto a TAC?</span></label>
                            <div id="tac-details" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded border">
                                <select id="process-tac-situacao" class="w-full border rounded px-3 py-2">
                                    <option value="">Status do TAC...</option>
                                    <option value="Em negociação">Em negociação</option>
                                    <option value="Celebrado">Celebrado</option>
                                    <option value="Recusado">Recusado</option>
                                    <option value="Finalizado">Finalizado</option>
                                </select>
                                <textarea id="process-tac-obs" class="w-full border rounded px-3 py-2 md:col-span-2" placeholder="Observações sobre o TAC"></textarea>
                            </div>
                            <textarea id="process-obs" class="w-full border rounded px-3 py-2" rows="3" placeholder="Observações Gerais"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-6 border-t">
                        <button type="button" onclick="showPage('processos')" class="px-6 py-2 border rounded hover:bg-gray-100">Cancelar</button>
                        <button type="button" onclick="submitProcessForm()" class="bg-blue-600 text-white px-8 py-2 rounded hover:bg-blue-700">Salvar</button>
                    </div>
                </form>
            </div>

            <div id="page-relatorios" class="page-content hidden animate-fadeIn no-print max-w-7xl mx-auto">
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h2 class="text-xl font-bold mb-4">Central de Relatórios</h2>
                    <div class="flex space-x-2 border-b mb-4 flex-wrap">
                        <button onclick="switchReportTab('geral')" id="tab-rep-geral" class="pb-2 px-2 border-b-2 report-tab-btn">Relatório Geral</button>
                        <button onclick="switchReportTab('status')" id="tab-rep-status" class="pb-2 px-2 border-b-2 report-tab-btn">Por Status</button>
                        <button onclick="switchReportTab('andamento')" id="tab-rep-andamento" class="pb-2 px-2 border-b-2 report-tab-btn">Andamento / Finalizados</button>
                        <button onclick="switchReportTab('distribuicao')" id="tab-rep-distribuicao" class="pb-2 px-2 border-b-2 report-tab-btn">Distribuição por Analista</button>
                        <button onclick="switchReportTab('prescricao')" id="tab-rep-prescricao" class="pb-2 px-2 border-b-2 report-tab-btn">Controle Prescricional</button>
                        <button onclick="switchReportTab('entregues')" id="tab-rep-entregues" class="pb-2 px-2 border-b-2 report-tab-btn">Entregues vs Pendentes</button>
                        <button onclick="switchReportTab('gerencial')" id="tab-rep-gerencial" class="pb-2 px-2 border-b-2 report-tab-btn">Gerencial Mensal</button>
                    </div>

                                        <div id="report-common-config" class="p-4 border rounded bg-gray-50 mb-4">
                        <h3 class="font-semibold mb-2">Configuração dos relatórios (exceto Gerencial Mensal)</h3>
                        <p class="text-sm text-gray-600 mb-2">Selecione os campos que devem aparecer no resultado e na exportação para Word.</p>
                        <div id="rep-field-selector" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-sm"></div>
                    </div>
                    <div id="filters-geral" class="report-filters hidden animate-fadeIn">
                        <h3 class="font-semibold mb-2">Filtros do Relatório Geral</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 border rounded bg-gray-50 mb-4">
                            <div><label class="text-xs font-bold text-gray-600">Processo SEI</label><input type="text" id="f-sei" class="border rounded px-2 py-1 w-full mt-1 text-sm"></div>
                            <div><label class="text-xs font-bold text-gray-600">Objeto</label><input type="text" id="f-objeto" class="border rounded px-2 py-1 w-full mt-1 text-sm"></div>
                            <div><label class="text-xs font-bold text-gray-600">Acusado</label><input type="text" id="f-acusado" class="border rounded px-2 py-1 w-full mt-1 text-sm"></div>
                            <div><label class="text-xs font-bold text-gray-600">Tipo de Pessoa</label><select id="f-tipo-pessoa" class="border rounded px-2 py-1 w-full mt-1 text-sm"><option value="">Todos</option><option value="PF">Pessoa Física</option><option value="PJ">Envolve Pessoa Jurídica</option></select></div>
                            
                            <div><label class="text-xs font-bold text-gray-600">Data Entrada (De)</label><input type="date" id="f-data-de" class="border rounded px-2 py-1 w-full mt-1 text-sm"></div>
                            <div><label class="text-xs font-bold text-gray-600">Data Entrada (Até)</label><input type="date" id="f-data-ate" class="border rounded px-2 py-1 w-full mt-1 text-sm"></div>
                            <div><label class="text-xs font-bold text-gray-600">Resultado</label><select id="f-resultado" class="border rounded px-2 py-1 w-full mt-1 text-sm"><option value="">Todos</option><option value="Não definida">Não definida</option><option value="Instauração de PAD">Instauração de PAD</option><option value="Instauração de PAR">Instauração de PAR</option><option value="Arquivado após análise preliminar">Arquivado após análise preliminar</option><option value="Arquivado após juízo de admissibilidade">Arquivado após juízo de admissibilidade</option></select></div>
                            <div><label class="text-xs font-bold text-gray-600">Penalidade Aplicável</label><select id="f-penalidade" class="border rounded px-2 py-1 w-full mt-1 text-sm"><option value="">Todas</option><option value="Advertência">Advertência</option><option value="Suspensão">Suspensão</option><option value="Demissão">Demissão</option><option value="Multa (PJ)">Multa (PJ)</option></select></div>
                            
                            <div><label class="text-xs font-bold text-gray-600">Unidade Origem</label><input type="text" id="f-unidade" class="border rounded px-2 py-1 w-full mt-1 text-sm"></div>
                            <div><label class="text-xs font-bold text-gray-600">Doc. Origem</label><input type="text" id="f-doc-origem" class="border rounded px-2 py-1 w-full mt-1 text-sm"></div>
                            <div class="lg:col-span-2"><label class="text-xs font-bold text-gray-600">Juntado a Processo</label><input type="text" id="f-juntado" class="border rounded px-2 py-1 w-full mt-1 text-sm"></div>
                            
                            <div class="lg:col-span-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-x-4 gap-y-3 pt-2 border-t mt-2">
                                <div class="flex items-center"><label class="text-sm flex items-center"><input type="checkbox" id="f-concluido" class="mr-2">Concluídos</label></div>
                                <div class="flex items-center"><label class="text-sm flex items-center"><input type="checkbox" id="f-prioritario" class="mr-2">Prioritários</label></div>
                                
                                <div class="flex flex-col">
                                    <label class="text-sm flex items-center"><input type="checkbox" id="f-epad" class="mr-2" onchange="toggleFilterDetail('f-epad-det')">Com ePAD</label>
                                    <input type="text" id="f-epad-det" class="hidden border rounded px-2 py-1 mt-1 text-xs w-full" placeholder="Detalhes (pesquisa)...">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-sm flex items-center"><input type="checkbox" id="f-inquerito" class="mr-2" onchange="toggleFilterDetail('f-inq-det')">Com Inquérito</label>
                                    <input type="text" id="f-inq-det" class="hidden border rounded px-2 py-1 mt-1 text-xs w-full" placeholder="Detalhes (pesquisa)...">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-sm flex items-center"><input type="checkbox" id="f-op-policial" class="mr-2" onchange="toggleFilterDetail('f-op-det')">Op. Policial</label>
                                    <input type="text" id="f-op-det" class="hidden border rounded px-2 py-1 mt-1 text-xs w-full" placeholder="Detalhes (pesquisa)...">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-sm flex items-center"><input type="checkbox" id="f-tac" class="mr-2" onchange="toggleFilterDetail('f-tac-det')">Apto a TAC</label>
                                    <input type="text" id="f-tac-det" class="hidden border rounded px-2 py-1 mt-1 text-xs w-full" placeholder="Detalhes (pesquisa)...">
                                </div>
                            </div>
                        </div>
                        <button onclick="generateGeneralReport()" class="bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto">Gerar Relatório Geral</button>
                    </div>

                    <div id="filters-status" class="report-filters hidden animate-fadeIn">
                        <h3 class="font-semibold mb-2">Relatório por Status</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label class="text-xs font-bold text-gray-600">Status:</label>
                                <select id="rep-status-val" class="border rounded px-3 py-2 w-full mt-1">
                                    <option value="">Todos os Status</option>
                                    <option value="Cadastrado">Cadastrado</option><option value="Aguardando Distribuição">Aguardando Distribuição</option>
                                    <option value="Em análise">Em análise</option>
                                    <option value="Pendente de análise do(a) Corregedor(a)">Pendente de análise do(a) Corregedor(a)</option>
                                    <option value="Concluído">Concluído</option>
                                </select>
                            </div>
                            <div><label class="text-xs font-bold text-gray-600">Data de Entrada (De):</label><input type="date" id="rep-status-de" class="border rounded px-3 py-2 w-full mt-1"></div>
                            <div><label class="text-xs font-bold text-gray-600">Data de Entrada (Até):</label><input type="date" id="rep-status-ate" class="border rounded px-3 py-2 w-full mt-1"></div>
                        </div>
                        <button onclick="generateStatusReport()" class="bg-blue-600 text-white px-4 py-2 rounded">Gerar Relatório</button>
                    </div>

                    <div id="filters-andamento" class="report-filters hidden animate-fadeIn">
                        <h3 class="font-semibold mb-2">Processos em Andamento ou Finalizados</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label class="text-xs font-bold text-gray-600">Fase do Processo:</label>
                                <select id="rep-andamento-tipo" class="border rounded px-3 py-2 w-full mt-1">
                                    <option value="andamento">Em Andamento</option>
                                    <option value="finalizado">Finalizados</option>
                                    <option value="todos">Todos</option>
                                </select>
                            </div>
                            <div><label class="text-xs font-bold text-gray-600">Data de Entrada (De):</label><input type="date" id="rep-andamento-de" class="border rounded px-3 py-2 w-full mt-1"></div>
                            <div><label class="text-xs font-bold text-gray-600">Data de Entrada (Até):</label><input type="date" id="rep-andamento-ate" class="border rounded px-3 py-2 w-full mt-1"></div>
                        </div>
                        <button onclick="generateProgressReport()" class="bg-blue-600 text-white px-4 py-2 rounded">Gerar Relatório</button>
                    </div>

                    <div id="filters-gerencial" class="report-filters hidden animate-fadeIn">
                        <h3 class="font-semibold mb-2">Relatório Gerencial Mensal</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label class="text-xs font-bold text-gray-600">Data de Entrada (De):</label><input type="date" id="rep-man-start" class="border rounded px-3 py-2 w-full mt-1"></div>
                            <div><label class="text-xs font-bold text-gray-600">Data de Entrada (Até):</label><input type="date" id="rep-man-end" class="border rounded px-3 py-2 w-full mt-1"></div>
                            <div class="flex items-end space-x-4 pb-1">
                                <label><input type="radio" name="rep-man-type" value="sintetico" checked> Sintético</label>
                                <label><input type="radio" name="rep-man-type" value="analitico"> Analítico</label>
                            </div>
                        </div>
                        <button onclick="generateManagerialReport()" class="bg-blue-600 text-white px-4 py-2 rounded">Gerar Relatório Gerencial</button>
                    </div>
                    
                    <div id="filters-distribuicao" class="report-filters hidden animate-fadeIn">
                         <h3 class="font-semibold mb-2">Relatório de Distribuição por Analista</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div><label class="text-xs font-bold text-gray-600">Analista:</label><select id="rep-dist-analista" class="border rounded px-3 py-2 w-full mt-1"><option value="">Todos</option></select></div>
                            <div><label class="text-xs font-bold text-gray-600">Distribuído de:</label><input type="date" id="rep-dist-start" class="border rounded px-3 py-2 w-full mt-1"></div>
                            <div><label class="text-xs font-bold text-gray-600">Distribuído até:</label><input type="date" id="rep-dist-end" class="border rounded px-3 py-2 w-full mt-1"></div>
                            <div class="flex items-end space-x-4 pb-1">
                                <label><input type="radio" name="rep-dist-type" value="sintetico" checked> Sintético</label>
                                <label><input type="radio" name="rep-dist-type" value="analitico"> Analítico</label>
                            </div>
                        </div>
                        <button onclick="generateDistributionReport()" class="bg-blue-600 text-white px-4 py-2 rounded">Gerar Relatório</button>
                    </div>
                    
                    <div id="filters-entregues" class="report-filters hidden animate-fadeIn">
                         <h3 class="font-semibold mb-2">Relatório de Processos Entregues vs. Pendentes</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div><label class="text-xs font-bold text-gray-600">Analista:</label><select id="rep-ent-analista" class="border rounded px-3 py-2 w-full mt-1"><option value="">Todos</option></select></div>
                            <div><label class="text-xs font-bold text-gray-600">Período (De):</label><input type="date" id="rep-ent-start" class="border rounded px-3 py-2 w-full mt-1"></div>
                            <div><label class="text-xs font-bold text-gray-600">Período (Até):</label><input type="date" id="rep-ent-end" class="border rounded px-3 py-2 w-full mt-1"></div>
                            <div class="flex items-end space-x-4 pb-1">
                                <label><input type="radio" name="rep-ent-type" value="sintetico" checked> Sintético</label>
                                <label><input type="radio" name="rep-ent-type" value="analitico"> Analítico</label>
                            </div>
                        </div>
                        <button onclick="generateDeliveredPendingReport()" class="bg-blue-600 text-white px-4 py-2 rounded">Gerar Relatório</button>
                    </div>
                    
                    <div id="filters-prescricao" class="report-filters hidden animate-fadeIn">
                         <h3 class="font-semibold mb-2">Relatório de Controle Prescricional</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div><label class="text-xs font-bold text-gray-600">Tipo de Penalidade:</label><select id="rep-presc-tipo" class="border rounded px-3 py-2 w-full mt-1"><option value="advertencia">Advertência</option><option value="suspensao">Suspensão</option><option value="demissao">Demissão</option></select></div>
                            <div class="flex items-end pb-1"><label class="text-sm flex items-center"><input type="checkbox" id="rep-presc-vencidos" class="mr-2"> Incluir já prescritos</label></div>
                            <div class="md:col-start-3 flex items-end space-x-4 pb-1">
                                <label><input type="radio" name="rep-presc-type" value="sintetico" checked> Sintético</label>
                                <label><input type="radio" name="rep-presc-type" value="analitico"> Analítico</label>
                            </div>
                        </div>
                        <button onclick="generatePrescriptionReport()" class="bg-blue-600 text-white px-4 py-2 rounded">Gerar Relatório</button>
                    </div>

                </div>
            </div>

            <div id="report-output" class="hidden bg-white p-8 shadow-lg mb-8 max-w-7xl mx-auto">
                <div class="flex justify-end space-x-2 mb-6 no-print">
                    <button onclick="window.print()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm flex items-center"><i data-lucide="printer" class="w-4 h-4 mr-1"></i> PDF / Imprimir</button>
                    <button onclick="exportToWord()" class="bg-blue-700 text-white px-3 py-1 rounded text-sm flex items-center"><i data-lucide="file-text" class="w-4 h-4 mr-1"></i> Word</button>
                    <button onclick="exportToExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-sm flex items-center"><i data-lucide="sheet" class="w-4 h-4 mr-1"></i> Excel</button>
                    <button onclick="closeReport()" class="bg-red-500 text-white px-3 py-1 rounded text-sm">Fechar</button>
                </div>
                <div id="report-content"></div>
            </div>

          <!-- PAINEL DE BACKUP (Adicione o id="panel-backup") -->
<div id="panel-backup" class="bg-white p-6 rounded-lg shadow mb-6">
  <!-- ... conteúdo do backup ... -->
</div>

<!-- PAINEL DE CONFIGURAÇÕES GERAIS (Adicione o id="panel-configs-gerais") -->
<div id="panel-configs-gerais" class="bg-white p-6 rounded-lg shadow mb-6">
  <!-- ... campos de título, subtítulo, prazos, etc ... -->
</div>

<!-- GERENCIAMENTO DE USUÁRIOS -->
<div class="bg-white p-6 rounded-lg shadow">
  <div class="flex items-start justify-between gap-4 mb-4">
    <div>
      <!-- Adicione os IDs no título e descrição -->
      <h2 id="users-manage-title" class="text-xl font-bold">Gerenciamento de Usuários</h2>
      <p id="users-manage-description" class="text-sm text-gray-500 mt-1">Administra contas de acesso do sistema.</p>
    </div>
    <button onclick="resetUserForm()" id="btn-user-new" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm">Novo usuário</button>
  </div>

  <form id="user-form" onsubmit="submitUserForm(event)" class="...">
    <!-- ... campos do formulário ... -->
    
    <div class="flex flex-col justify-end gap-2">
      <!-- Adicione o id="user-admin-wrap" na label do checkbox -->
      <label id="user-admin-wrap" class="flex items-center gap-2 text-sm text-gray-700">
        <input type="checkbox" id="user-admin" class="rounded">
        <span>Administrador</span>
      </label>
      <!-- ... botões de salvar ... -->
    </div>
  </form>

  <!-- TABELA DE USUÁRIOS (Adicione o id="panel-users-table") -->
  <div id="panel-users-table" class="table-container border">
    <!-- ... <table> ... -->
  </div>
</div>

<script>
// --- CONFIGURAÇÃO SUPABASE ---
const SUPABASE_URL = 'https://buqtsnywwsnzdyllesky.supabase.co';
const SUPABASE_KEY = 'sb_publishable_AniXfRCWjroliyeA7FUr9w_rHEM3Xst';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --- VARIÁVEIS DE ESTADO GLOBAIS ---
let currentUser = null;
let users = [];
let processos = []; 
let currentAccused = [];
let currentView = 'cards';
let isPriorityFilterActive = false;
let lastReportData = [];
let lastReportIsManagerial = false;
let config = {
  orgName: 'Controle Correicional', subtitle: 'Sistema Institucional', defaultUnit: 'SEAP', itemsPerPage: 20,
  pjYears: 5, pf: { adv: 180, susp: 2, dem: 5 },
  alerts: { crit: { adv: 30, susp: 60, dem: 90, task: 5 }, high: { adv: 60, susp: 120, dem: 180, task: 15 } }
};

// --- VERIFICAÇÃO DE SESSÃO (Mantém logado) ---
supabaseClient.auth.getSession().then(({ data: { session } }) => {
  if (session) {
    currentUser = session.user;
    // Busca os dados de perfil (incluindo se é admin)
    supabaseClient.from('usuarios').select('is_admin, nome_completo').eq('id', currentUser.id).single()
      .then(({data}) => {
        if(data) {
          currentUser.is_admin = data.is_admin;
          currentUser.nome_completo = data.nome_completo;
          if(data.is_admin) document.getElementById('admin-badge').classList.remove('hidden');
        }
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        initApp();
      });
  }
});

// --- AUTH & LOGIN SEGURO ---
async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('log-user').value.trim(); 
  const password = document.getElementById('log-pass').value;
  const err = document.getElementById('error-msg');
  const btn = document.getElementById('btn-login');
  
  btn.innerText = 'Verificando...';
  err.classList.add('hidden');

  const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
    email: email,
    password: password,
  });

  if (authError) {
    btn.innerText = 'Entrar';
    err.innerText = "E-mail ou senha inválidos.";
    err.classList.remove('hidden');
    return;
  }

  if (authData.user) {
    currentUser = authData.user;
    const { data: userData } = await supabaseClient.from('usuarios').select('is_admin, nome_completo').eq('id', currentUser.id).single();

    if (userData) {
      currentUser.is_admin = userData.is_admin;
      currentUser.nome_completo = userData.nome_completo;
      if (userData.is_admin) document.getElementById('admin-badge').classList.remove('hidden');
    } else {
      currentUser.is_admin = false;
    }

    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    initApp();
  }
}

// --- LOGOUT À PROVA DE FALHAS ---
async function logout() {
  try {
    await supabaseClient.auth.signOut();
  } catch (error) {
    console.error("Erro ao comunicar logout:", error);
  } finally {
    currentUser = null;
    document.getElementById('app').style.display = 'none';
    document.getElementById('login-overlay').style.display = 'flex';
    if(document.getElementById('log-pass')) document.getElementById('log-pass').value = '';
    
    for (let key in localStorage) {
      if (key.startsWith('sb-') && key.endsWith('-auth-token')) localStorage.removeItem(key);
    }
    window.location.reload(true);
  }
}

// --- NAVEGAÇÃO E CONTROLE DE TELAS ---
function showPage(pageId) {
  if(pageId !== 'relatorios') closeReport();
  document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
  document.getElementById(`page-${pageId}`).classList.remove('hidden');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-blue-50', 'text-blue-700'));
  document.getElementById(`nav-${pageId}`)?.classList.add('bg-blue-50', 'text-blue-700');
  
  if(pageId === 'dashboard') loadDashboard();
  if(pageId === 'processos') refreshProcessos();
  if(pageId === 'novo-processo') resetForm();
  
  if(pageId === 'configuracoes') {
    loadConfigsToForm();
    fetchUsers();
    setupConfiguracoesView(); // Chama a função que esconde/mostra painéis
  }
  
  if(pageId === 'relatorios') { populateAnalystFilters(); switchReportTab('geral'); }
}

// --- CONTROLE DE VISIBILIDADE (ADMIN VS USUÁRIO) ---
function setupConfiguracoesView() {
  const isAdmin = !!currentUser?.is_admin;
  
  const panelBackup = document.getElementById('panel-backup');
  const panelGerais = document.getElementById('panel-configs-gerais');
  const panelUsersTable = document.getElementById('panel-users-table');
  const btnNewUser = document.getElementById('btn-user-new');
  const checkAdminWrap = document.getElementById('user-admin-wrap');
  
  if(panelBackup) panelBackup.classList.toggle('hidden', !isAdmin);
  if(panelGerais) panelGerais.classList.toggle('hidden', !isAdmin);
  if(panelUsersTable) panelUsersTable.classList.toggle('hidden', !isAdmin);
  if(btnNewUser) btnNewUser.classList.toggle('hidden', !isAdmin);
  if(checkAdminWrap) checkAdminWrap.classList.toggle('hidden', !isAdmin);

  const titleEl = document.getElementById('users-manage-title');
  const descEl = document.getElementById('users-manage-description');

  if (!isAdmin) {
    if(titleEl) titleEl.innerText = 'Meu Perfil';
    if(descEl) descEl.innerText = 'Atualize seus dados pessoais e altere sua senha.';
    
    document.getElementById('user-id').value = currentUser.id;
    document.getElementById('user-name').value = currentUser.nome_completo || '';
    document.getElementById('user-username').value = currentUser.email || '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-password').placeholder = 'Digite para alterar a senha';
    document.getElementById('btn-user-save').innerText = 'Atualizar meus dados';
  } else {
    if(titleEl) titleEl.innerText = 'Gerenciamento de Usuários';
    if(descEl) descEl.innerText = 'Administra contas de acesso do sistema.';
    document.getElementById('btn-user-save').innerText = 'Salvar usuário';
    resetUserForm();
  }
}

// --- SALVAR/EDITAR USUÁRIOS E SENHAS ---
async function submitUserForm(e) {
  e.preventDefault();
  const isAdmin = !!currentUser?.is_admin;
  const id = document.getElementById('user-id').value;
  const nome = document.getElementById('user-name').value.trim();
  const username = document.getElementById('user-username').value.trim();
  const senha = document.getElementById('user-password').value;
  const isUserAdmin = isAdmin ? document.getElementById('user-admin').checked : false;

  const payloadPerfil = { nome_completo: nome, username: username, is_admin: isUserAdmin };

  let result;
  if (id) {
    result = await supabaseClient.from('usuarios').update(payloadPerfil).eq('id', id);
  } else {
    showToast('Novos usuários devem ser criados no painel do Supabase (Authentication).', 'error');
    return;
  }

  if (result.error) {
    console.error(result.error);
    showToast('Erro ao atualizar perfil.', 'error');
    return;
  }

  if (senha) {
    if (String(id) === String(currentUser.id)) {
      const { error: passError } = await supabaseClient.auth.updateUser({ password: senha });
      if (passError) {
        showToast('Erro ao atualizar a senha: ' + passError.message, 'error');
        return;
      }
    } else {
      showToast('Perfil atualizado. Para mudar a senha de OUTRO usuário, use o painel do Supabase.', 'warning');
      resetUserForm();
      fetchUsers();
      return;
    }
  }

  showToast('Dados atualizados com sucesso!', 'success');
  
  if (isAdmin) {
    resetUserForm();
    fetchUsers();
  } else {
    document.getElementById('user-password').value = ''; // Apenas limpa o campo de senha para o usuário comum
  }
} 

        async function deleteUser(userId) {
            if (!currentUser?.is_admin) {
                showToast('Apenas administradores podem excluir usuários.', 'error');
                return;
            }
            if (String(userId) === String(currentUser.id)) {
                showToast('Não é permitido excluir o próprio usuário administrador.', 'error');
                return;
            }
            if (!confirm('Deseja realmente excluir este usuário?')) return;

            const { error } = await supabaseClient.from('usuarios').delete().eq('id', userId);
            if (error) {
                console.error(error);
                showToast('Erro ao excluir usuário.', 'error');
                return;
            }

            showToast('Usuário excluído com sucesso!', 'success');
            fetchUsers();
        }

        // --- RELATÓRIOS ---
        function switchReportTab(tab) {
            closeReport(); document.querySelectorAll('.report-filters').forEach(el => el.classList.add('hidden')); document.getElementById(`filters-${tab}`).classList.remove('hidden');
            const commonConfig = document.getElementById('report-common-config');
            if (commonConfig) commonConfig.classList.toggle('hidden', tab === 'gerencial');
            const active = ['border-blue-600', 'text-blue-600', 'font-bold'], inactive = ['border-transparent', 'text-gray-500'];
            document.querySelectorAll('.report-tab-btn').forEach(btn => { btn.classList.remove(...active); btn.classList.add(...inactive); });
            const activeBtn = document.getElementById(`tab-rep-${tab}`); activeBtn.classList.add(...active); activeBtn.classList.remove(...inactive);
        }

        function populateAnalystFilters() {
            const analysts = [...new Set(processos.map(p => p.analista).filter(Boolean))].sort();
            [document.getElementById('rep-dist-analista'), document.getElementById('rep-ent-analista')].forEach(select => {
                if(!select) return; const currentValue = select.value; select.innerHTML = '<option value="">Todos</option>';
                analysts.forEach(a => select.innerHTML += `<option value="${a}">${a}</option>`); select.value = currentValue;
            });
            document.getElementById('analistas-list').innerHTML = analysts.map(a => `<option value="${a}"></option>`).join('');
        }
        
        const REPORT_FIELDS = {
            id: { label: 'ID', get: p => p.id || '—' },
            sei: { label: 'SEI', get: p => p.sei || '—' },
            data_ent: { label: 'Data de Entrada', get: p => formatDate(p.data_ent) },
            objeto: { label: 'Objeto', get: p => p.objeto || '—' },
            unidade_origem: { label: 'Unidade de Origem', get: p => p.unidade_origem || '—' },
            doc_origem: { label: 'Documento de Origem', get: p => p.doc_origem || '—' },
            juntado: { label: 'Juntado a Processo', get: p => p.juntado || '—' },
            relacionados: { label: 'Processos Relacionados', get: p => p.relacionados || '—' },
            op_policial: { label: 'Operação Policial', get: p => p.op_policial ? 'Sim' : 'Não' },
            op_policial_detalhes: { label: 'Detalhes Op. Policial', get: p => p.op_policial_detalhes || '—' },
            possui_inquerito: { label: 'Possui Inquérito', get: p => p.possui_inquerito ? 'Sim' : 'Não' },
            inquerito_detalhes: { label: 'Detalhes Inquérito', get: p => p.inquerito_detalhes || '—' },
            cad_epad: { label: 'Cadastro no ePAD', get: p => p.cad_epad ? 'Sim' : 'Não' },
            epad_detalhes: { label: 'Detalhes ePAD', get: p => p.epad_detalhes || '—' },
            prioritario: { label: 'Prioritário', get: p => p.prioritario ? 'Sim' : 'Não' },
            tipo_acusado: { label: 'Tipo de Pessoa', get: p => p.tipo_acusado || '—' },
            penalidades: { label: 'Penalidades Aplicáveis', get: p => p.penalidades || '—' },
            data_conhecimento: { label: 'Data de Conhecimento', get: p => formatDate(p.data_conhecimento) },
            calc_advertencia: { label: 'Prescrição Advertência', get: p => formatDate(p.calc_advertencia) },
            calc_suspensao: { label: 'Prescrição Suspensão', get: p => formatDate(p.calc_suspensao) },
            calc_demissao: { label: 'Prescrição Demissão', get: p => formatDate(p.calc_demissao) },
            calc_pj: { label: 'Prescrição PJ', get: p => formatDate(p.calc_pj) },
            analista: { label: 'Analista', get: p => p.analista || '—' },
            data_distribuicao: { label: 'Data de Distribuição', get: p => formatDate(p.data_distribuicao) },
            prazo_nt_data: { label: 'Prazo NT', get: p => formatDate(p.prazo_nt_data) },
            data_entrega_nt: { label: 'Data Entrega NT', get: p => formatDate(p.data_entrega_nt) },
            ips: { label: 'IPS?', get: p => p.ips === true ? 'Sim' : p.ips === false ? 'Não' : '—' },
            status: { label: 'Status', get: p => getStatusFromProcess(p) },
            status_manual: { label: 'Status Manual', get: p => p.status_manual || '—' },
            data_despacho: { label: 'Data Assinatura Despacho', get: p => formatDate(p.data_despacho) },
            acusados: { label: 'Acusado(s)', get: p => Array.isArray(p.acusados) && p.acusados.length ? p.acusados.join(', ') : '—' },
            resultado: { label: 'Resultado', get: p => p.resultado || '—' },
            doc_resp: { label: 'Documento de Resposta', get: p => p.doc_resp || '—' },
            tac_apto: { label: 'Apto a TAC', get: p => p.tac_apto ? 'Sim' : 'Não' },
            tac_sit: { label: 'Situação TAC', get: p => p.tac_sit || '—' },
            tac_obs: { label: 'Observações TAC', get: p => p.tac_obs || '—' },
            obs: { label: 'Observações Gerais', get: p => p.obs || '—' }
        };

        const REPORT_FIELD_ORDER = Object.keys(REPORT_FIELDS);

        function initReportFieldSelector() {
            const container = document.getElementById('rep-field-selector');
            if (!container) return;
            const defaultFields = new Set(['sei', 'objeto', 'analista', 'status', 'resultado', 'data_ent']);
            container.innerHTML = REPORT_FIELD_ORDER.map(key => {
                const checked = defaultFields.has(key) ? 'checked' : '';
                return `<label class="flex items-center gap-2"><input type="checkbox" class="rep-field" value="${key}" ${checked}> ${REPORT_FIELDS[key].label}</label>`;
            }).join('');
        }

        function getSelectedReportFields() {
            const fields = Array.from(document.querySelectorAll('.rep-field:checked')).map(el => el.value).filter(v => REPORT_FIELDS[v]);
            return fields.length ? fields : ['sei', 'objeto', 'analista', 'status'];
        }

        function setLastReport(data, isManagerial = false) {
            lastReportData = Array.isArray(data) ? [...data] : [];
            lastReportIsManagerial = isManagerial;
        }

        function formatFieldValueForExport(fieldKey, process) {
            return REPORT_FIELDS[fieldKey]?.get(process) ?? '—';
        }

        const renderAnalyticTable = (data) => {
            if (!data || data.length === 0) return '<p class="text-sm text-gray-500">Nenhum registro encontrado.</p>';
            const fields = getSelectedReportFields();
            const head = fields.map(f => `<th class="border p-1 whitespace-nowrap">${REPORT_FIELDS[f].label}</th>`).join('');
            let table = `<div class="analytic-list border-t mt-2 pt-2"><div class="overflow-auto max-h-[60vh]"><table class="w-full min-w-max text-xs border"><thead class="bg-gray-100"><tr>${head}</tr></thead><tbody>`;
            data.forEach(p => {
                table += '<tr>' + fields.map(f => `<td class="border p-1 whitespace-nowrap">${formatFieldValueForExport(f, p)}</td>`).join('') + '</tr>';
            });
            return table + '</tbody></table></div></div>';
        }

        function generateGeneralReport() {
            closeReport(); let filtered = [...processos]; const v = id => document.getElementById(id).value.toLowerCase(); const c = id => document.getElementById(id).checked;
            if (v('f-sei')) filtered = filtered.filter(p => p.sei && p.sei.toLowerCase().includes(v('f-sei'))); if (v('f-objeto')) filtered = filtered.filter(p => p.objeto && p.objeto.toLowerCase().includes(v('f-objeto'))); if (v('f-acusado')) filtered = filtered.filter(p => p.acusados && p.acusados.join(' ').toLowerCase().includes(v('f-acusado'))); if (v('f-data-de')) filtered = filtered.filter(p => p.data_ent >= document.getElementById('f-data-de').value); if (v('f-data-ate')) filtered = filtered.filter(p => p.data_ent <= document.getElementById('f-data-ate').value); if (v('f-resultado')) filtered = filtered.filter(p => p.resultado === document.getElementById('f-resultado').value); if (v('f-tipo-pessoa') === 'PF') filtered = filtered.filter(p => p.tipo_acusado === 'Pessoa Física'); if (v('f-tipo-pessoa') === 'PJ') filtered = filtered.filter(p => p.tipo_acusado === 'Pessoa Jurídica' || p.tipo_acusado === 'Pessoa Física + Jurídica'); if (v('f-unidade')) filtered = filtered.filter(p => p.unidade_origem && p.unidade_origem.toLowerCase().includes(v('f-unidade'))); if (v('f-doc-origem')) filtered = filtered.filter(p => p.doc_origem && p.doc_origem.toLowerCase().includes(v('f-doc-origem'))); if (v('f-juntado')) filtered = filtered.filter(p => p.juntado && p.juntado.toLowerCase().includes(v('f-juntado'))); if (v('f-penalidade')) filtered = filtered.filter(p => p.penalidades === document.getElementById('f-penalidade').value); if (c('f-concluido')) filtered = filtered.filter(p => p.data_despacho); if (c('f-prioritario')) filtered = filtered.filter(p => p.prioritario);
            if (c('f-epad')) { filtered = filtered.filter(p => p.cad_epad); const d = v('f-epad-det'); if(d) filtered = filtered.filter(p => p.epad_detalhes && p.epad_detalhes.toLowerCase().includes(d)); } if (c('f-inquerito')) { filtered = filtered.filter(p => p.possui_inquerito); const d = v('f-inq-det'); if(d) filtered = filtered.filter(p => p.inquerito_detalhes && p.inquerito_detalhes.toLowerCase().includes(d)); } if (c('f-op-policial')) { filtered = filtered.filter(p => p.op_policial); const d = v('f-op-det'); if(d) filtered = filtered.filter(p => p.op_policial_detalhes && p.op_policial_detalhes.toLowerCase().includes(d)); } if (c('f-tac')) { filtered = filtered.filter(p => p.tac_apto); const d = v('f-tac-det'); if(d) filtered = filtered.filter(p => p.tac_obs && p.tac_obs.toLowerCase().includes(d)); }
            let html = `<h2 class="text-2xl font-bold text-center mb-4">Relatório Geral de Processos (${filtered.length})</h2>${renderAnalyticTable(filtered)}`;
            setLastReport(filtered, false);
            document.getElementById('report-content').innerHTML = html; document.getElementById('report-output').classList.remove('hidden');
        }
        
        function generateStatusReport() {
            closeReport(); const statusTarget = document.getElementById('rep-status-val').value; const start = document.getElementById('rep-status-de').value; const end = document.getElementById('rep-status-ate').value;
            let filtered = processos.filter(p => { let match = true; if (statusTarget) match = match && getStatusFromProcess(p) === statusTarget; if (start) match = match && p.data_ent >= start; if (end) match = match && p.data_ent <= end; return match; });
            let html = `<h2 class="text-2xl font-bold text-center mb-4">Relatório de Processos por Status (${filtered.length})</h2><p class="text-sm text-center mb-4">Status: ${statusTarget || 'Todos'} | Período: ${start ? formatDate(start) : 'Início'} a ${end ? formatDate(end) : 'Hoje'}</p>${renderAnalyticTable(filtered)}`;
            setLastReport(filtered, false);
            document.getElementById('report-content').innerHTML = html; document.getElementById('report-output').classList.remove('hidden');
        }

        function generateProgressReport() {
            closeReport(); const tipo = document.getElementById('rep-andamento-tipo').value; const start = document.getElementById('rep-andamento-de').value; const end = document.getElementById('rep-andamento-ate').value;
            let filtered = processos.filter(p => { let match = true; if (start) match = match && p.data_ent >= start; if (end) match = match && p.data_ent <= end; if (tipo === 'finalizado') match = match && (p.data_despacho != null && p.data_despacho !== ''); else if (tipo === 'andamento') match = match && (!p.data_despacho || p.data_despacho === ''); return match; });
            let html = `<h2 class="text-2xl font-bold text-center mb-4">Relatório de Processos - ${tipo === 'andamento' ? 'Em Andamento' : tipo === 'finalizado' ? 'Finalizados' : 'Todos'} (${filtered.length})</h2><p class="text-sm text-center mb-4">Período: ${start ? formatDate(start) : 'Início'} a ${end ? formatDate(end) : 'Hoje'}</p>${renderAnalyticTable(filtered)}`;
            setLastReport(filtered, false);
            document.getElementById('report-content').innerHTML = html; document.getElementById('report-output').classList.remove('hidden');
        }
        
        function generateDistributionReport() {
            closeReport(); const analista = document.getElementById('rep-dist-analista').value; const start = document.getElementById('rep-dist-start').value, end = document.getElementById('rep-dist-end').value; const isAnalytic = document.querySelector('input[name="rep-dist-type"]:checked').value === 'analitico';
            let filtered = processos.filter(p => p.analista && (!analista || p.analista === analista) && (!start || p.data_distribuicao >= start) && (!end || p.data_distribuicao <= end));
            let html = `<h2 class="text-2xl font-bold text-center mb-4">Relatório de Distribuição de Processos</h2><p class="text-center text-sm mb-4">Total: ${filtered.length} processos</p>`; if (isAnalytic) html += renderAnalyticTable(filtered);
            setLastReport(filtered, false);
            document.getElementById('report-content').innerHTML = html; document.getElementById('report-output').classList.remove('hidden');
        }

        function generatePrescriptionReport() {
            closeReport(); const tipo = document.getElementById('rep-presc-tipo').value; const incluirVencidos = document.getElementById('rep-presc-vencidos').checked; const isAnalytic = document.querySelector('input[name="rep-presc-type"]:checked').value === 'analitico'; const hoje = new Date().toISOString().split('T')[0]; const key = `calc_${tipo}`;
            let filtered = processos.filter(p => p[key] && (incluirVencidos || p[key] >= hoje)); filtered.sort((a,b) => (a[key] > b[key]) ? 1 : -1);
            let html = `<h2 class="text-2xl font-bold text-center mb-4">Relatório de Controle Prescricional - ${tipo.charAt(0).toUpperCase() + tipo.slice(1)} (${filtered.length})</h2>`;
            if (isAnalytic) { html += `<table class="w-full text-xs text-left border-collapse border border-gray-300"><thead class="bg-gray-100"><tr><th class="border p-1">Processo SEI</th><th class="border p-1">Objeto</th><th class="border p-1">Data Conhecimento</th><th class="border p-1">Data Prescrição</th><th class="border p-1">Dias Restantes</th></tr></thead><tbody>`; filtered.forEach(p => { const diasRestantes = diffDays(hoje, p[key]); const cor = diasRestantes < 0 ? 'text-red-600' : diasRestantes < config.alerts.crit.adv ? 'text-red-600' : 'text-gray-800'; html += `<tr><td class="border p-1 font-mono">${p.sei}</td><td class="border p-1">${p.objeto}</td><td class="border p-1">${formatDate(p.data_conhecimento)}</td><td class="border p-1 font-bold ${cor}">${formatDate(p[key])}</td><td class="border p-1 font-bold ${cor}">${diasRestantes < 0 ? 'PRESCRITO' : diasRestantes}</td></tr>`; }); html += `</tbody></table>`; }
            setLastReport(filtered, false);
            document.getElementById('report-content').innerHTML = html; document.getElementById('report-output').classList.remove('hidden');
        }

        function generateDeliveredPendingReport() {
            closeReport(); const analista = document.getElementById('rep-ent-analista').value; const start = document.getElementById('rep-ent-start').value, end = document.getElementById('rep-ent-end').value; const isAnalytic = document.querySelector('input[name="rep-ent-type"]:checked').value === 'analitico';
            let filtered = processos.filter(p => p.analista && (!analista || p.analista === analista) && (!start || p.data_distribuicao >= start) && (!end || p.data_distribuicao <= end)); const entregues = filtered.filter(p => p.data_entrega_nt), pendentes = filtered.filter(p => !p.data_entrega_nt);
            let html = `<h2 class="text-2xl font-bold text-center mb-4">Relatório de Entregues vs. Pendentes</h2><p class="text-center text-sm mb-6">Filtros: Analista (${analista || 'Todos'}), Período (${formatDate(start)} a ${formatDate(end)})</p><div class="report-item"><span class="font-medium">Entregues</span><span>${entregues.length}</span></div>`; if (isAnalytic) html += renderAnalyticTable(entregues); html += `<div class="report-item mt-4"><span class="font-medium">Pendentes</span><span>${pendentes.length}</span></div>`; if (isAnalytic) html += renderAnalyticTable(pendentes);
            setLastReport(filtered, false);
            document.getElementById('report-content').innerHTML = html; document.getElementById('report-output').classList.remove('hidden');
        }

        function diffDays(d1, d2) { if(!d1 || !d2) return 0; return Math.ceil((new Date(d2) - new Date(d1)) / (1000 * 3600 * 24)); }
        
        function calculateAverageDays(list, startField, endField) { const today = new Date().toISOString().split('T')[0]; const durations = list.map(p => { if(p[startField]) return diffDays(p[startField], p[endField] || today); return null; }).filter(d => d !== null); if (durations.length === 0) return 0; return Math.round(durations.reduce((acc, curr) => acc + curr, 0) / durations.length); }


        function renderManagerialFixedTable(data) {
            if (!data || data.length === 0) return '';
            let html = '<div class="analytic-list border-t mt-2 pt-2"><div class="overflow-auto max-h-[60vh]"><table class="w-full min-w-max text-xs border"><thead class="bg-gray-100"><tr><th class="border p-1 whitespace-nowrap">Nº SEI</th><th class="border p-1 whitespace-nowrap">Objeto</th><th class="border p-1 whitespace-nowrap">Acusado</th><th class="border p-1 whitespace-nowrap">Data de conhecimento do fato</th><th class="border p-1 whitespace-nowrap">Resultado</th></tr></thead><tbody>';
            data.forEach(p => {
                const acusado = Array.isArray(p.acusados) && p.acusados.length ? p.acusados.join(', ') : '—';
                html += `<tr><td class="border p-1 whitespace-nowrap font-mono">${p.sei || '—'}</td><td class="border p-1 whitespace-nowrap">${p.objeto || '—'}</td><td class="border p-1 whitespace-nowrap">${acusado}</td><td class="border p-1 whitespace-nowrap">${formatDate(p.data_conhecimento)}</td><td class="border p-1 whitespace-nowrap">${p.resultado || '—'}</td></tr>`;
            });
            return html + '</tbody></table></div></div>';
        }

        function generateManagerialReport() {
            closeReport(); const startStr = document.getElementById('rep-man-start').value, endStr = document.getElementById('rep-man-end').value; const type = document.querySelector('input[name="rep-man-type"]:checked').value, isAnalytic = type === 'analitico';
            const filtered = processos.filter(p => { const refDate = p.data_ent || p.data_conhecimento; if (!refDate) return !startStr && !endStr; if (startStr && refDate < startStr) return false; if (endStr && refDate > endStr) return false; return true; });
            const renderRow = (label, data, analyticList) => `<div class="report-item"><span>${label}</span><span class="font-bold">${data}</span></div>` + (isAnalytic ? renderManagerialFixedTable(analyticList) : '');
            
            const archivedList = filtered.filter(p => p.resultado === 'Arquivado após análise preliminar' || p.resultado === 'Arquivado após juízo de admissibilidade'); const aptTacList = filtered.filter(p => p.tac_apto); const avgProcessTime = calculateAverageDays(filtered, 'data_ent', 'data_despacho');
            const analyzedList = filtered.filter(p => getStatusFromProcess(p) === 'Aguardando Distribuição'); const avgAnalysisTime = calculateAverageDays(analyzedList, 'data_distribuicao', 'data_entrega_nt');
            const juntadoList = filtered.filter(p => p.juntado && p.juntado.length > 5); const juizoList = filtered.filter(p => getStatusFromProcess(p) === 'Em análise'); const ipsList = filtered.filter(p => getStatusFromProcess(p) === 'Pendente de análise do(a) Corregedor(a)' || p.ips === true);
            
            const resultadoMap = { 'arquivados_preliminar': filtered.filter(p => p.resultado === 'Arquivado após análise preliminar'), 'arquivados_admissibilidade': filtered.filter(p => p.resultado === 'Arquivado após juízo de admissibilidade'), 'celebracao_tac': filtered.filter(p => p.resultado === 'Para celebrar TAC'), 'instauracao_pad': filtered.filter(p => p.resultado === 'Instauração de PAD'), 'instauracao_par': filtered.filter(p => p.resultado === 'Instauração de PAR'), 'instauracao_sinpa': filtered.filter(p => p.resultado === 'Instauração de SINPA'), 'instauracao_sinac': filtered.filter(p => p.resultado === 'Instauração de SINAC'), 'instauracao_sinve': filtered.filter(p => p.resultado === 'Instauração de SINVE'), 'min_transportes': filtered.filter(p => p.resultado === 'Encaminhado para o Min. dos Transportes'), 'instauracao_ips': filtered.filter(p => p.resultado === 'Instauração de IPS') };
            const tacMap = { 'negociacao': filtered.filter(p => p.tac_sit === 'Em negociação'), 'celebrados': filtered.filter(p => p.tac_sit === 'Celebrado'), 'recusados': filtered.filter(p => p.tac_sit === 'Recusado'), 'finalizados': filtered.filter(p => p.tac_sit === 'Finalizado') };

            let html = `<div class="text-center mb-6"><h2 class="text-xl font-bold">Relatório Gerencial - ${(startStr || endStr) ? `${formatDate(startStr)} a ${formatDate(endStr)}` : "Todo o período"}</h2></div><div class="report-section"><div class="report-header">Resumo Geral</div>${renderRow('Quantidade total de processos', filtered.length, filtered)}${renderRow('Quantidade de processos arquivados', archivedList.length, archivedList)}${renderRow('Processos aptos a celebração de TAC', aptTacList.length, aptTacList)}${renderRow('Tempo médio (em dias)', avgProcessTime, [])}</div><div class="report-section"><div class="report-header">Notícias de irregularidade</div><div class="report-sub-header">Análise preliminar</div>${renderRow('Quantidade de processos analisados', analyzedList.length, analyzedList)}${renderRow('Tempo médio de análise (em dias)', avgAnalysisTime, [])}<div class="report-sub-header">Resultados</div>${renderRow('Número de processos arquivados', resultadoMap.arquivados_preliminar.length, resultadoMap.arquivados_preliminar)}${renderRow('Encaminhados para juízo de admissibilidade', juizoList.length, juizoList)}${renderRow('Quantidade de juntados a processo existente', juntadoList.length, juntadoList)}</div><div class="report-section"><div class="report-header">Juízo de Admissibilidade</div><div class="report-sub-header">Processos Analisados – IPS</div>${renderRow('Número de Processos analisados', ipsList.length, ipsList)}${renderRow('Tempo médio de análise (em dias)', calculateAverageDays(ipsList, 'data_distribuicao', 'data_entrega_nt'), [])}<div class="report-sub-header">Resultados</div>${renderRow('Processos arquivados', resultadoMap.arquivados_admissibilidade.length, resultadoMap.arquivados_admissibilidade)}${renderRow('Celebração de TAC', resultadoMap.celebracao_tac.length, resultadoMap.celebracao_tac)}${renderRow('Instauração de PAD', resultadoMap.instauracao_pad.length, resultadoMap.instauracao_pad)}${renderRow('Instauração de PAR', resultadoMap.instauracao_par.length, resultadoMap.instauracao_par)}${renderRow('Instauração de SINPA', resultadoMap.instauracao_sinpa.length, resultadoMap.instauracao_sinpa)}${renderRow('Instauração de SINAC', resultadoMap.instauracao_sinac.length, resultadoMap.instauracao_sinac)}${renderRow('Instauração de SINVE', resultadoMap.instauracao_sinve.length, resultadoMap.instauracao_sinve)}${renderRow('Min. Dos Transportes', resultadoMap.min_transportes.length, resultadoMap.min_transportes)}${renderRow('Instauração de IPS', resultadoMap.instauracao_ips.length, resultadoMap.instauracao_ips)}</div><div class="report-section"><div class="report-header">Termo de Ajustamento de Conduta – TAC</div>${renderRow('TACs Em Negociação', tacMap.negociacao.length, tacMap.negociacao)}${renderRow('TACs Celebrados', tacMap.celebrados.length, tacMap.celebrados)}${renderRow('TACs Recusados', tacMap.recusados.length, tacMap.recusados)}${renderRow('TACs Finalizados', tacMap.finalizados.length, tacMap.finalizados)}</div>`;
            setLastReport(filtered, true);
            document.getElementById('report-content').innerHTML = html; document.getElementById('report-output').classList.remove('hidden');
        }

        function exportToWord() { 
            const sourceHTML = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export</title></head><body>" + document.getElementById("report-content").innerHTML + "</body></html>";
            const el = document.createElement("a"); el.href = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML); el.download = 'relatorio.doc'; el.click();
        }
        
        function exportToExcel() {
            if (!lastReportData || lastReportData.length === 0) {
                showToast('Não há dados no relatório para exportação.', 'error');
                return;
            }

            if (lastReportIsManagerial) {
                const table = document.querySelector("#report-content table");
                if (table) {
                    const wb = XLSX.utils.table_to_book(table, { sheet: "Relatorio" });
                    XLSX.writeFile(wb, 'Relatorio_Gerencial.xlsx');
                } else {
                    showToast('Não há tabela no relatório.', 'error');
                }
                return;
            }

            const rows = lastReportData.map(p => {
                const row = {};
                REPORT_FIELD_ORDER.forEach(field => {
                    row[REPORT_FIELDS[field].label] = formatFieldValueForExport(field, p);
                });
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Relatorio');
            XLSX.writeFile(wb, 'Relatorio_Completo.xlsx');
        }

        function exportBackup() {
            const backupData = { config: config, processos: processos };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
            const el = document.createElement('a'); el.setAttribute("href", dataStr); el.setAttribute("download", "backup_corregedoria_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(el); el.click(); el.remove(); showToast("Backup exportado!");
        }

        function importBackup(event) {
            const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.config) { config = importedData.config; await saveConfigsToSupabase(); }
                    if (importedData.processos && Array.isArray(importedData.processos)) {
                        for(const p of importedData.processos) { await saveProcessToSupabase(p); }
                    }
                    showToast("Backup importado. Recarregando..."); setTimeout(() => window.location.reload(), 2000); 
                } catch (err) { alert("Erro ao ler JSON válido."); }
            };
            reader.readAsText(file); event.target.value = '';
        }

        // --- INICIALIZAÇÃO DE UI ---
        document.addEventListener('DOMContentLoaded', () => { 
            lucide.createIcons(); 
            Inputmask({ mask: "99999.999999/9999-99", placeholder: "_", showMaskOnHover: false, showMaskOnFocus: true }).mask(document.querySelectorAll(".mask-sei"));
            setViewMode(localStorage.getItem('correg_view_mode') || 'cards');
            setupPrazoHandlers();
            initReportFieldSelector();
        });

</script>
</body>
</html>









